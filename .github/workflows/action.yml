name: Vionix Pipeline

on:
  push:
  schedule:
    - cron: "0 2,5,10,13 * * *"

jobs:

# -------------------------------------------------
# 1Ô∏è‚É£ SETUP
# -------------------------------------------------
  setup:
    name: üß± Setup Environment
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Ensure pip cache dir exists (FIXES WARNING)
      - name: Prepare pip cache directory
        run: |
          mkdir -p ~/.cache/pip

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: "6.1.0"

# -------------------------------------------------
# 2Ô∏è‚É£ INSTALL
# -------------------------------------------------
  install:
    name: üì¶ Install Dependencies
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install private wheel
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          RELEASE_TAG: ${{ secrets.RELEASE_TAG }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          OWNER="simplycodesmart"
          REPO="Vionix"
          API_URL="https://api.github.com/repos/$OWNER/$REPO/releases/tags/$RELEASE_TAG"
          RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" "$API_URL")
          WHEEL_NAME=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name | endswith(".whl")) | .name')
          WHEEL_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name == "'$WHEEL_NAME'") | .url')
          curl -L -H "Authorization: token $GH_TOKEN" -H "Accept: application/octet-stream" "$WHEEL_URL" -o "$WHEEL_NAME"
          pip install "$WHEEL_NAME"

      - name: Install requirements
        run: pip install -r requirements.txt

# -------------------------------------------------
# 3Ô∏è‚É£ PREPARE
# -------------------------------------------------
  prepare:
    name: üß© Prepare Assets & Secrets
    runs-on: ubuntu-latest
    needs: install

    steps:
      - uses: actions/checkout@v4

      - name: Write OAuth files
        run: |
          python - <<'EOF'
          import json, os
          with open('client_secrets.json', 'w') as f:
              json.dump(json.loads(os.environ['JSON_CLIENT_YT']), f, indent=2)
          with open('oauth.json', 'w') as f:
              json.dump(json.loads(os.environ['JSON_OAUTH_YT']), f, indent=2)
          EOF
        env:
          JSON_CLIENT_YT: ${{ secrets.JSON_CLIENT_YT }}
          JSON_OAUTH_YT: ${{ secrets.JSON_OAUTH_YT }}

      - name: Copy assets
        run: |
          cp assets/bg.png .
          cp assets/font_kn.ttf .
          cp assets/output_image.png .

# -------------------------------------------------
# 4Ô∏è‚É£ RUN
# -------------------------------------------------
  run:
    name: üöÄ Run Vionix
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - uses: actions/checkout@v4

      - name: Pick random music
        id: music
        run: |
          NUM=$((1 + RANDOM % 23))
          echo "num=$NUM" >> $GITHUB_OUTPUT
          cp assets/music/$NUM.mp3 .

      - name: Execute main
        run: python main.py "${{ steps.music.outputs.num }}"
